import sys
from pathlib import Path
from snakemake.utils import min_version
import subprocess


min_version("7.19")

configfile: "config/config.yaml"
configfile: "config/targets.yaml"
configfile: "config/report.yaml"

include: "rules/common.smk"


# Workflow version
__version__ = get_version_str(Path(".").resolve())

# Targets
## Output
OUTPUT_NAME = config["OUTPUT_NAME"]
OUTDIR = Path(config["OUTPUT_DIRECTORY"])
OUTDIR.mkdir(parents=True, exist_ok=True)

## Context
if "CONTEXT_FASTA" not in config.keys() or config["CONTEXT_FASTA"] is None:
    CONTEXT_FASTA = OUTDIR/"context"/"sequences.fasta"
    if not Path(config["GISAID_YAML"]).is_file():
        sys.exit(f"Neither '{config['GISAID_YAML']}' or a context FASTA were found (see README.md).")
else:
    CONTEXT_FASTA = config["CONTEXT_FASTA"]

## Logging
LOGDIR = OUTDIR / "logs"

## report
REPORT_DIR = Path(OUTDIR/"report")
REPORT_DIR.mkdir(parents=True, exist_ok=True)


# Rules
include: "rules/fetch.smk"
include: "rules/fasta.smk"
include: "rules/asr.smk"
include: "rules/demix.smk"
include: "rules/vaf.smk"
include: "rules/pangolin.smk"
include: "rules/distances.smk"
include: "rules/evolution.smk"
include: "rules/report.smk"
include: "rules/context.smk"


rule all:
    input:
        OUTDIR/f"{OUTPUT_NAME}.report.html"
